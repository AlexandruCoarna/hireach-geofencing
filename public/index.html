<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
          name="viewport">
    <meta content="ie=edge" http-equiv="X-UA-Compatible">
    <title>Document</title>
</head>
<body>
<button id="notification-subscribe">Subscribe</button>
<button id="notification-unsubscribe">Unsubscribe</button>
</body>

<script>
    const subscribeButton = document.querySelector("#notification-subscribe");
    const unsubscribeButton = document.querySelector("#notification-unsubscribe");

    subscribeButton.addEventListener("click", subscribeUser);
    unsubscribeButton.addEventListener("click", unsubscribeUser);

    let swRegistration = null;


    navigator.serviceWorker.register('sw.js')
        .then(function (swReg) {
            swRegistration = swReg;
        })
        .catch(err => {
            window.alert(`ERROR -> ${ JSON.stringify(err) }`);
        });

    function subscribeUser() {
        swRegistration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: "BDLemtuPfbg6viIoGSgzkkeB211dtacOjHaVCqKEJL88qMuY3mnx44eVCPNYp5Wd54EdbYS8YIhBjPABuRkZvSE"
        })
            .then(subscription => {
                updateSubscriptionOnServer(subscription);
            })
            .catch(err => {
                window.alert(`ERROR -> ${ JSON.stringify(err) }`);
            });
    }

    async function updateSubscriptionOnServer(subscription) {

        const response1 = await fetch("/supervisor", {
            method: "POST",
            body: JSON.stringify({ id: 1, subscription: subscription || {} }),
            headers: { 'Content-Type': 'application/json' }
        });

        if (!response1.ok) {
            window.alert(`ERROR! -> ${ JSON.stringify(await response1.json()) }`);
            return;
        }

        const response2 = await fetch("/target/supervisor", {
            method: subscription ? "PUT" : "DELETE",
            body: JSON.stringify({ targetId: 1, supervisorId: 1 }),
            headers: { 'Content-Type': 'application/json' }
        });

        if (!response2.ok) {
            window.alert(`ERROR! -> ${ JSON.stringify(await response2.json()) }`);
        }
    }

    function unsubscribeUser() {
        swRegistration.pushManager.getSubscription()
            .then(function (subscription) {
                if (subscription) {
                    return subscription.unsubscribe();
                }
            })
            .then(function () {
                updateSubscriptionOnServer(null);
            })
            .catch(function (err) {
                window.alert(`ERROR -> ${ JSON.stringify(err) }`);
            })
    }
</script>
</html>
